"use strict";(self.webpackChunksap_calculator=self.webpackChunksap_calculator||[]).push([[572],{572(_,G,d){d.d(G,{ImportCalculatorComponent:()=>J});var v=d(9769),m=d(5119),i=d(5547),w=d(3142),E=d.t(w,2),b=d(8332),O=d.t(b,2),A=d(5207),D=d.t(A,2);const k=new Map,C=new Map;(A??D).forEach(s=>{const e=String(s.Id),o=Number(s.Tier);k.set(e,s.Name),Number.isFinite(o)&&C.set(e,{name:s.Name,tier:o})});const x=b??O,$=new Map((w??E).map(s=>[String(s.Id),s.Name])),j=new Map(x.map(s=>[String(s.Id),s.Name])),L={0:"Turtle",1:"Puppy",2:"Star",5:"Golden",6:"Unicorn",7:"Danger"},U={playerPack:"pP",opponentPack:"oP",playerToy:"pT",playerToyLevel:"pTL",playerHardToy:"pHT",playerHardToyLevel:"pHTL",opponentToy:"oT",opponentToyLevel:"oTL",opponentHardToy:"oHT",opponentHardToyLevel:"oHTL",turn:"t",playerGoldSpent:"pGS",opponentGoldSpent:"oGS",playerRollAmount:"pRA",opponentRollAmount:"oRA",playerSummonedAmount:"pSA",opponentSummonedAmount:"oSA",playerLevel3Sold:"pL3",opponentLevel3Sold:"oL3",playerTransformationAmount:"pTA",opponentTransformationAmount:"oTA",playerPets:"p",opponentPets:"o",allPets:"ap",logFilter:"lf",customPacks:"cp",oldStork:"os",tokenPets:"tp",komodoShuffle:"ks",mana:"m",triggersConsumed:"tc",showAdvanced:"sa",showSwallowedLevels:"swl",ailmentEquipment:"ae",name:"n",attack:"a",health:"h",exp:"e",equipment:"eq",belugaSwallowedPet:"bSP",timesHurt:"tH"};class V{parseReplayForCalculator(e,o,l){const n=e?.UserBoard??l?.userBoard,r=e?.OpponentBoard??l?.opponentBoard,t=(p,c,f=null)=>{const P=p?.[c];return void 0===P?f:P},S=p=>{const c=(p?.Mins?.Items||[]).filter(Boolean),f=Array(5).fill(null);return c.forEach((P,h)=>{let y=P.Poi?.x;void 0===y&&(y=h),y>=0&&y<5&&(f[y]=(p=>{if(!p)return null;const c=String(p.Enu??0),f=p.At?.Temp??0,P=p.Hp?.Temp??0;let h=null;if("182"===c){const g=p?.MiMs?.Lsts?.WhiteWhaleAbility||[];if(g.length>0){const R=g[0]?.Enu;h=k.get(String(R))||`Pet #${R}`}}const y=(p=>{const c=p?.Pow?.SabertoothTigerAbility;return Number.isFinite(c)?c:null})(p),B=(p?.Abil||[]).map(g=>g?.TrCo).filter(g=>Number.isFinite(g)),N={name:k.get(c)||null,attack:(p.At?.Perm??0)+f,health:(p.Hp?.Perm??0)+P,exp:p.Exp||0,equipment:p.Perk?{name:$.get(String(p.Perk))||"Unknown Perk"}:null,mana:p.Mana||0,belugaSwallowedPet:h,sarcasticFringeheadSwallowedPet:null,abominationSwallowedPet1:null,abominationSwallowedPet2:null,abominationSwallowedPet3:null,abominationSwallowedPet1Level:1,abominationSwallowedPet2Level:1,abominationSwallowedPet3Level:1,battlesFought:0,triggersConsumed:B.length>0?Math.max(...B):0};return null!==y&&(N.timesHurt=y),N})(P))}),f.reverse()},F=p=>{const c=(p?.Rel?.Items||[]).find(f=>f&&f.Enu);if(c){const f=String(c.Enu);return{name:j.get(f)||null,level:c.Lvl||1}}return{name:null,level:1}},I=F(n),M=F(r),T=this.buildCustomPacksFromGenesis(o,e),W=this.findCustomPackFromDeck(T,n?.Deck),Q=this.findCustomPackFromDeck(T,r?.Deck);return{playerPack:L[n?.Pack]||W?.name||"Turtle",opponentPack:L[r?.Pack]||Q?.name||"Turtle",playerToy:I.name,playerToyLevel:String(I.level),playerHardToy:null,playerHardToyLevel:1,opponentToy:M.name,opponentToyLevel:String(M.level),opponentHardToy:null,opponentHardToyLevel:1,turn:t(n,"Tur",1)||1,playerGoldSpent:t(n,"GoSp",0)||0,opponentGoldSpent:t(r,"GoSp",0)||0,playerRollAmount:t(n,"Rold",0)||0,opponentRollAmount:t(r,"Rold",0)||0,playerSummonedAmount:t(n,"MiSu",0)||0,opponentSummonedAmount:t(r,"MiSu",0)||0,playerLevel3Sold:t(n,"MSFL",0)||0,opponentLevel3Sold:t(r,"MSFL",0)||0,playerTransformationAmount:t(n,"TrTT",0)||0,opponentTransformationAmount:t(r,"TrTT",0)||0,playerPets:S(n),opponentPets:S(r),allPets:!1,logFilter:null,customPacks:T,oldStork:!1,tokenPets:!1,komodoShuffle:!1,mana:!0,triggersConsumed:!0,showAdvanced:!0,showSwallowedLevels:!1,ailmentEquipment:!1}}buildCustomPacksFromGenesis(e,o){const l=[e?.Bor?.Deck,o?.UserBoard?.Deck,o?.OpponentBoard?.Deck].filter(a=>a&&Array.isArray(a.Minions)),n=[],r=new Set,t=new Set;for(const a of l){const u=a?.Id?String(a.Id):null;if(u&&r.has(u))continue;u&&r.add(u);const S=this.buildCustomPackFromDeck(a,t);S&&n.push({...S,deckId:u})}return n}generateCalculatorLink(e){const o=window.location.origin+window.location.pathname,l=this.stripDefaultValues(e),n=this.truncateKeys(l),r=JSON.stringify(n);return`${o}?c=${btoa(r)}`}buildCustomPackFromDeck(e,o){if(!e||!Array.isArray(e.Minions))return null;const l=e.Minions.map(a=>String(a)),n={1:[],2:[],3:[],4:[],5:[],6:[]};for(const a of l){const u=C.get(a);u&&n[u.tier]&&n[u.tier].push(u.name)}const r=a=>{const u=a.slice(0,10);for(;u.length<10;)u.push(null);return u};let t=e.Title||"Custom Pack";if(o.has(t)){let a=2;for(;o.has(`${t} (${a})`);)a+=1;t=`${t} (${a})`}return o.add(t),{name:t,tier1Pets:r(n[1]),tier2Pets:r(n[2]),tier3Pets:r(n[3]),tier4Pets:r(n[4]),tier5Pets:r(n[5]),tier6Pets:r(n[6])}}findCustomPackFromDeck(e,o){if(!o)return null;const l=o?.Id?String(o.Id):null;if(l){const r=e.find(t=>t.deckId===l);if(r)return r}const n=o?.Title;return n&&e.find(r=>r.name===n)||null}stripDefaultValues(e){const o={};"Turtle"!==e.playerPack&&(o.playerPack=e.playerPack),"Turtle"!==e.opponentPack&&(o.opponentPack=e.opponentPack),e.playerToy&&(o.playerToy=e.playerToy),e.playerToyLevel&&"1"!==e.playerToyLevel&&(o.playerToyLevel=e.playerToyLevel),e.opponentToy&&(o.opponentToy=e.opponentToy),e.opponentToyLevel&&"1"!==e.opponentToyLevel&&(o.opponentToyLevel=e.opponentToyLevel),11!==e.turn&&(o.turn=e.turn),10!==e.playerGoldSpent&&(o.playerGoldSpent=e.playerGoldSpent),10!==e.opponentGoldSpent&&(o.opponentGoldSpent=e.opponentGoldSpent),4!==e.playerRollAmount&&(o.playerRollAmount=e.playerRollAmount),4!==e.opponentRollAmount&&(o.opponentRollAmount=e.opponentRollAmount),0!==e.playerSummonedAmount&&(o.playerSummonedAmount=e.playerSummonedAmount),0!==e.opponentSummonedAmount&&(o.opponentSummonedAmount=e.opponentSummonedAmount),0!==e.playerLevel3Sold&&(o.playerLevel3Sold=e.playerLevel3Sold),0!==e.opponentLevel3Sold&&(o.opponentLevel3Sold=e.opponentLevel3Sold),0!==e.playerTransformationAmount&&(o.playerTransformationAmount=e.playerTransformationAmount),0!==e.opponentTransformationAmount&&(o.opponentTransformationAmount=e.opponentTransformationAmount),e.allPets&&(o.allPets=!0),e.oldStork&&(o.oldStork=!0),e.tokenPets&&(o.tokenPets=!0),e.komodoShuffle&&(o.komodoShuffle=!0),e.mana&&(o.mana=!0),e.triggersConsumed&&(o.triggersConsumed=!0),e.showAdvanced&&(o.showAdvanced=!0),e.showSwallowedLevels&&(o.showSwallowedLevels=!0),e.ailmentEquipment&&(o.ailmentEquipment=!0),e.logFilter&&(o.logFilter=e.logFilter),e.customPacks&&e.customPacks.length>0&&(o.customPacks=e.customPacks);const l=t=>{if(!t||!t.name)return null;const a={name:t.name};return 0!==t.attack&&(a.attack=t.attack),0!==t.health&&(a.health=t.health),0!==t.exp&&(a.exp=t.exp),0!==t.mana&&(a.mana=t.mana),t.equipment&&(a.equipment=t.equipment),t.triggersConsumed&&(a.triggersConsumed=t.triggersConsumed),null!==t.belugaSwallowedPet&&(a.belugaSwallowedPet=t.belugaSwallowedPet),t.timesHurt&&(a.timesHurt=t.timesHurt),a},n=e.playerPets.map(l);n.some(t=>null!==t)&&(o.playerPets=n);const r=e.opponentPets.map(l);return r.some(t=>null!==t)&&(o.opponentPets=r),o}truncateKeys(e){if(Array.isArray(e))return e.map(o=>this.truncateKeys(o));if(null!==e&&"object"==typeof e){const o={};for(const l in e)o[U[l]||l]=this.truncateKeys(e[l]);return o}return e}}var Y=d(375);let K=(()=>{class s{parser=new V;parseReplayForCalculator(o,l,n){return this.parser.parseReplayForCalculator(o,l,n)}buildCustomPacksFromGenesis(o,l){return this.parser.buildCustomPacksFromGenesis(o,l)}generateCalculatorLink(o){return this.parser.generateCalculatorLink(o)}static \u0275fac=function(l){return new(l||s)};static \u0275prov=Y.jDH({token:s,factory:s.\u0275fac,providedIn:"root"})}return s})();var X=d(8799);function z(s,e){if(1&s&&(i.j41(0,"div",9),i.EFF(1),i.k0s()),2&s){const o=i.XpG();i.R7$(),i.JRh(o.errorMessage)}}let J=(()=>{class s{replayCalcService;http;importFunc;formGroup=new m.gE({calcCode:new m.MJ(null,m.k0.required),turn:new m.MJ(1,m.k0.min(1))});errorMessage="";loading=!1;constructor(o,l){this.replayCalcService=o,this.http=l}ngOnInit(){}submit(){this.errorMessage="";const o=this.formGroup.get("calcCode"),l=o?.value?.trim();if(!l)return void(this.errorMessage="Paste calculator JSON or replay JSON.");let n;o?.setValue("",{emitEvent:!1}),o?.markAsPristine(),o?.markAsUntouched(),o?.updateValueAndValidity({emitEvent:!1});try{n=JSON.parse(l)}catch{return void(this.errorMessage="Invalid JSON. Please paste a valid calculator or replay JSON.")}if(n?.Pid&&!n?.Actions){const r=Number(n?.T??this.formGroup.get("turn").value);return!Number.isFinite(r)||r<=0?void(this.errorMessage="Enter a valid turn number."):(this.loading=!0,void this.http.post("/api/replay-battle",{Pid:n.Pid,T:r}).subscribe({next:t=>{this.loading=!1;const a=t?.battle;a?this.importReplayBattle(a,t?.genesisBuildModel):this.errorMessage="Replay lookup failed to return a battle."},error:t=>{this.loading=!1,this.errorMessage=t?.error?.error||"Failed to fetch replay data."}}))}if(n?.UserBoard&&n?.OpponentBoard)this.importReplayBattle(n,n?.GenesisBuildModel,{userBoard:n?.UserBoard,opponentBoard:n?.OpponentBoard});else{if(n?.Actions){const r=Number(this.formGroup.get("turn").value??n?.T);if(!Number.isFinite(r)||r<=0)return void(this.errorMessage="Enter a valid turn number.");let t=0,a=null;for(const u of n.Actions)if(0===u?.Type&&u?.Battle&&(t+=1,t===r)){try{a=JSON.parse(u.Battle)}catch{return void(this.errorMessage=`Failed to parse battle JSON for turn ${r}.`)}break}return a?void this.importReplayBattle(a,n?.GenesisBuildModel,{userBoard:n?.UserBoard,opponentBoard:n?.OpponentBoard}):void(this.errorMessage=`No battle found for turn ${r}.`)}this.importFunc(l)?alert("Import successful"):this.errorMessage="Import failed."}}importReplayBattle(o,l,n){const r=this.replayCalcService.parseReplayForCalculator(o,l,n);this.importFunc(JSON.stringify(r))?alert("Import successful"):this.errorMessage="Import failed."}static \u0275fac=function(l){return new(l||s)(i.rXU(K),i.rXU(X.Qq))};static \u0275cmp=i.VBU({type:s,selectors:[["app-import-calculator"]],inputs:{importFunc:"importFunc"},decls:14,vars:4,consts:[[1,"form-group",3,"formGroup"],[1,"text-muted","mb-2"],["id","calcCode","rows","8","formControlName","calcCode",1,"form-control","mb-2","calc-textarea"],[1,"d-flex","align-items-end","gap-3","flex-wrap","mb-2"],["for","turnNumber",1,"form-label"],["id","turnNumber","type","number","min","1","formControlName","turn",1,"form-control"],[1,"btn","btn-primary",3,"click","disabled"],[1,"warning","mb-2"],["class","text-danger mb-2",4,"ngIf"],[1,"text-danger","mb-2"]],template:function(l,n){1&l&&(i.j41(0,"div",0)(1,"div",1),i.EFF(2," Paste calculator JSON or replay JSON. Replay inputs can include Actions, a single battle JSON, or a Pid lookup. "),i.k0s(),i.nrm(3,"textarea",2),i.j41(4,"div",3)(5,"div")(6,"label",4),i.EFF(7,"Turn (1-based)"),i.k0s(),i.nrm(8,"input",5),i.k0s(),i.j41(9,"button",6),i.bIt("click",function(){return n.submit()}),i.EFF(10),i.k0s()(),i.j41(11,"div",7),i.EFF(12," Warning: This will overwrite any existing custom packs. Any custom packs in the import will be added. "),i.k0s(),i.DNE(13,z,2,1,"div",8),i.k0s()),2&l&&(i.Y8G("formGroup",n.formGroup),i.R7$(9),i.Y8G("disabled",n.loading),i.R7$(),i.SpI(" ",n.loading?"Fetching...":"Import / Replay"," "),i.R7$(3),i.Y8G("ngIf",n.errorMessage))},dependencies:[v.MD,v.bT,m.X1,m.me,m.Q0,m.BC,m.cb,m.VZ,m.j4,m.JD],styles:[".calc-textarea[_ngcontent-%COMP%]{min-height:180px;font-family:Courier New,Courier,monospace;white-space:pre;overflow-wrap:normal;overflow:auto;resize:vertical}"]})}return s})()}}]);